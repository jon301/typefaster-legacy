(function(){var a={}.hasOwnProperty,b=function(b,c){function d(){this.constructor=b}for(var e in c)a.call(c,e)&&(b[e]=c[e]);return d.prototype=c.prototype,b.prototype=new d,b.__super__=c.prototype,b};define(["jquery","underscore","templates","marionette","js_logger","punycode","string_fromcodepoint"],function(a,c,d,e,f,g){"use strict";var h,i;return h=function(c){function e(){return i=e.__super__.constructor.apply(this,arguments)}return b(e,c),e.prototype.el="#typezone-view",e.prototype.template=d["typefaster/static/scripts/templates/typezone.ejs"],e.prototype.ui={entries:".entry",textarea:".typezone-text",input:".typezone-input"},e.prototype.events={"keydown .typezone-input":"onKeydown","keypress .typezone-input":"onKeyPress","compositionstart .typezone-input":"onCompositionStart","compositionend .typezone-input":"onCompositionEnd"},e.prototype.debugEvent=function(a){return this.logger.debug(a.type),"KeyboardEvent"===a.originalEvent.constructor.name?(this.logger.debug("keyCode="+a.keyCode+" ("+String.fromCharCode(a.keyCode)+")"),this.logger.debug("charCode="+a.charCode+" ("+String.fromCharCode(a.charCode)+")"),this.logger.debug("which="+a.which+" ("+String.fromCharCode(a.which)+")"),this.logger.debug("keyIdentifier="+a.originalEvent.keyIdentifier)):"CompositionEvent"===a.originalEvent.constructor.name?this.logger.debug("data="+(a.data||a.originalEvent.data)):void 0},e.prototype.onKeydown=function(a){var b;return this.debugEvent(a),this.focused&&void 0!==a.originalEvent&&(b=a.which,8===b&&this.gameController.trigger("entry:deleted"),27===b)?(this.gameController.trigger("human:reset"),this.reset()):void 0},e.prototype.onKeyPress=function(a){var b,c;return this.debugEvent(a),this.focused&&void 0!==a.originalEvent&&(c=a.which,b=String.fromCodePoint(c))?this.gameController.trigger("entry:typed",b):void 0},e.prototype.onCompositionStart=function(a){return this.debugEvent(a),this.ui.entries.filter(".focus").addClass("composition")},e.prototype.onCompositionEnd=function(a){var b;return this.debugEvent(a),this.ui.entries.filter(".focus").removeClass("composition"),this.focused&&void 0!==a.originalEvent&&(b=a.data||a.originalEvent.data)?this.gameController.trigger("entry:typed",b):void 0},e.prototype.initialize=function(a){return this.logger=f.get("TypeZoneView"),this.gameController=a.gameController},e.prototype.onRender=function(){var b=this;return this.$el.show(),this.focus(),a("#typezone-container").on("click.typezone",a.proxy(this.focus,this)),a(window).on("resize.typezone",function(){return clearTimeout(b.resizingTimeout),b.resizingTimeout=setTimeout(function(){return b.scrollToEntry(a(".current"))},200)}),a(window).on("blur.typezone",function(){return b.blur()}),this.listenTo(this.gameController,"entry:is_correct",function(a){var c,d;return c=b.ui.entries.eq(a),d=b.ui.entries.eq(a+1),c.removeClass("current focus").addClass("correct"),d?(d.addClass("current focus"),b.scrollToEntry(d)):void 0}),this.listenTo(this.gameController,"entry:is_incorrect",function(a){var c,d;return c=b.ui.entries.eq(a),d=b.ui.entries.eq(a+1),c.removeClass("current focus").addClass("incorrect"),d?(d.addClass("current focus"),b.scrollToEntry(d)):void 0}),this.listenTo(this.gameController,"entry:is_reset",function(a){var c,d;return c=b.ui.entries.eq(a),b.ui.entries.removeClass("current focus"),c.removeClass("correct incorrect").addClass("current focus"),0!==a?(d=b.ui.entries.eq(a-1),b.scrollToEntry(d)):void 0}),this.listenTo(this.gameController,"human:stop",function(){return b.disable()})},e.prototype.scrollToEntry=function(a){var b=this;return a.length&&0!==a.parent().position().top&&!this.animating?(this.animating=!0,this.ui.textarea.stop(!0).animate({scrollTop:this.ui.textarea.scrollTop()+a.parent().position().top},function(){return b.animating=!1})):void 0},e.prototype.reset=function(){var a;return this.ui.entries.removeClass("correct incorrect focus current"),this.ui.input.val(""),this.disabled=!1,this.focused=!1,a=this.ui.entries.eq(0),a.addClass("current"),this.scrollToEntry(a),this.focus()},e.prototype.disable=function(){return this.disabled=!0,this.blur()},e.prototype.focus=function(b){return this.ui.input.focus(),this.focused||this.disabled||(this.logger.debug("focus typezone"),this.focused=!0,this.gameController.startListen(),this.$(".current").addClass("focus"),a("#typezone-container").addClass("focus"),a("body").on("click.typezone",a.proxy(this.blur,this))),b?(b.preventDefault(),b.stopPropagation()):void 0},e.prototype.blur=function(){return this.focused?(this.logger.debug("blur typezone"),this.focused=!1,this.gameController.stopListen(),this.$(".current").removeClass("focus"),a("#typezone-container").removeClass("focus"),a("body").off("click.typezone",a.proxy(this.blur,this))):void 0},e.prototype.serializeData=function(){return{entries:this.gameController.entries,punycode:g}},e.prototype.onClose=function(){return a("#typezone-container").off(".typezone"),a(window).off(".typezone"),a("body").off(".typezone")},e}(e.ItemView)})}).call(this);
(function(){var a={}.hasOwnProperty,b=function(b,c){function d(){this.constructor=b}for(var e in c)a.call(c,e)&&(b[e]=c[e]);return d.prototype=c.prototype,b.prototype=new d,b.__super__=c.prototype,b};define(["jquery","underscore","templates","marionette","js_logger","punycode","string_fromcodepoint"],function(a,c,d,e,f,g){"use strict";var h,i;return h=function(c){function e(){return i=e.__super__.constructor.apply(this,arguments)}return b(e,c),e.prototype.el="#typezone-view",e.prototype.template=d["typefaster/static/scripts/templates/typezone.ejs"],e.prototype.ui={entries:".entry",textarea:".typezone-text",input:".typezone-input"},e.prototype.events={"click .typezone-panel":"focus","keydown .typezone-input":"onKeydown","keypress .typezone-input":"onKeyPress","compositionstart .typezone-input":"onCompositionStart","compositionend .typezone-input":"onCompositionEnd"},e.prototype.debugEvent=function(a){return"KeyboardEvent"===a.originalEvent.constructor.name?this.logger.debug(a.type,"keyCode="+a.keyCode+" ("+String.fromCharCode(a.keyCode)+")","charCode="+a.charCode+" ("+String.fromCharCode(a.charCode)+")","which="+a.which+" ("+String.fromCharCode(a.which)+")","keyIdentifier="+a.originalEvent.keyIdentifier):"CompositionEvent"===a.originalEvent.constructor.name?this.logger.debug(a.type,"data="+(a.data||a.originalEvent.data)):void 0},e.prototype.onKeydown=function(a){var b;return this.debugEvent(a),this.$el.hasClass("focus")&&void 0!==a.originalEvent&&(b=a.which,8===b&&this.gameController.trigger("keyboard:backspace"),27===b)?(this.gameController.trigger("keyboard:escape"),this.reset()):void 0},e.prototype.onKeyPress=function(a){var b,c;return this.debugEvent(a),this.$el.hasClass("focus")&&void 0!==a.originalEvent&&(c=a.which,b=String.fromCodePoint(c),b&&c&&8!==c&&27!==c)?this.gameController.trigger("keyboard:char",b):void 0},e.prototype.onCompositionStart=function(a){return this.debugEvent(a),this.ui.entries.filter(".current").addClass("composition")},e.prototype.onCompositionEnd=function(a){var b;return this.debugEvent(a),this.ui.entries.filter(".current").removeClass("composition"),this.$el.hasClass("focus")&&void 0!==a.originalEvent&&(b=a.data||a.originalEvent.data)?this.gameController.trigger("keyboard:char",b):void 0},e.prototype.initialize=function(a){return this.logger=f.get("TypeZoneView"),this.gameController=a.gameController},e.prototype.onRender=function(){var b=this;return this.$el.show(),this.focus(),a(window).on("resize.typezone",function(){return clearTimeout(b.resizingTimeout),b.resizingTimeout=setTimeout(function(){return b.scrollToEntry(a(".current"))},200)}),a(window).on("blur.typezone",function(){return b.blur()}),this.listenTo(this.gameController,"entry:is_correct",function(a,c){var d,e;if(d=b.ui.entries.eq(c),e=b.ui.entries.eq(c+1),"human"===a.getType()){if(d.removeClass("current").addClass("correct"),e)return e.addClass("current"),b.scrollToEntry(e)}else if(d.css("borderColor","transparent"),e)return e.css("borderColor",a.getColor())}),this.listenTo(this.gameController,"entry:is_incorrect",function(a,c){var d,e;if(d=b.ui.entries.eq(c),e=b.ui.entries.eq(c+1),"human"===a.getType()){if(d.removeClass("current").addClass("incorrect"),e)return e.addClass("current"),b.scrollToEntry(e)}else if(d.css("borderColor","transparent"),e)return e.css("borderColor",a.getColor())}),this.listenTo(this.gameController,"entry:is_reset",function(a,c){var d,e;return d=b.ui.entries.eq(c),"human"!==a.getType()?(b.ui.entries.css("borderColor","transparent"),d.css("borderColor",a.getColor())):(b.ui.entries.removeClass("current"),d.removeClass("correct incorrect").addClass("current"),0!==c?(e=b.ui.entries.eq(c-1),b.scrollToEntry(e,d)):void 0)}),this.listenTo(this.gameController,"player:add",function(a){var c;return c=b.ui.entries.eq(0),"human"===a.getType()?c.addClass("current"):c.css("borderColor",a.getColor())}),this.listenTo(this.gameController,"human:stop",function(){return b.disable()})},e.prototype.scrollToEntry=function(a,b){var c=this;return b||(b=a),a.length&&0!==a.position().top&&!this.animating?(this.animating=!0,this.ui.textarea.stop(!0).animate({scrollTop:this.ui.textarea.scrollTop()+a.position().top},function(){return c.animating=!1,c.ui.input.offset(b.offset())})):this.ui.input.offset(b.offset())},e.prototype.disable=function(){return this.undelegateEvents(),this.blur()},e.prototype.reset=function(){var a;return this.delegateEvents(),this.ui.entries.removeClass("correct incorrect current"),this.ui.input.val(""),a=this.ui.entries.eq(0),a.addClass("current"),this.scrollToEntry(a),this.ui.entries.css("borderColor","transparent"),a.css("borderColor","red"),this.focus()},e.prototype.focus=function(b){return this.ui.input.focus(),this.$el.hasClass("focus")||(this.logger.debug("focus typezone"),this.$el.addClass("focus"),this.ui.input.offset(this.$(".current").offset()),a("body").on("click.typezone",a.proxy(this.blur,this))),b?(b.preventDefault(),b.stopPropagation()):void 0},e.prototype.blur=function(){return this.$el.hasClass("focus")?(this.logger.debug("blur typezone"),this.$(".current").removeClass("focus"),this.$el.removeClass("focus"),a("body").off("click.typezone",a.proxy(this.blur,this))):void 0},e.prototype.serializeData=function(){return{entries:this.gameController.entries,punycode:g}},e.prototype.onClose=function(){return a(window).off(".typezone"),a("body").off(".typezone")},e}(e.ItemView)})}).call(this);